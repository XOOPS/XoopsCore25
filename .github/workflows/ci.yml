name: CI
on: [push, pull_request]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    name: PHP ${{ matrix.php }}${{ matrix.deps && format(' / {0}', matrix.deps) || '' }}${{ matrix.coverage && ' / Coverage' || '' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        include:
          # Lowest supported dependencies test
          - php: "7.4"
            deps: "lowest"
          # Standard tests across supported versions
          # Note: xoops/base-requires25 supports ^7.4.0 || ^8.4.0
          # PHP 8.0-8.3 are NOT supported by the dependency
          - php: "7.4"
          - php: "8.4"
          - php: "8.5"
          # Coverage run
          - php: "8.4"
            coverage: true

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2
        with:
          php-version: ${{ matrix.php }}
          extensions: intl, mbstring, mysqli
          tools: composer
          coverage: ${{ matrix.coverage && 'xdebug' || 'none' }}

      - name: Show versions
        run: |
          php -v
          composer --version

      - name: Get Composer cache dir
        id: composer-cache
        run: echo "dir=$(composer config cache-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: composer-${{ runner.os }}-${{ matrix.php }}-${{ matrix.deps || 'stable' }}-${{ hashFiles('**/composer.json', '.github/workflows/ci.yml') }}
          restore-keys: |
            composer-${{ runner.os }}-${{ matrix.php }}-

      - name: Create composer.json
        working-directory: htdocs/class/libraries
        env:
          PHP_VERSION: ${{ matrix.php }}
        run: |
          cat > composer.json << EOL
          {
            "name": "xoopscore25/libraries",
            "license": "GPL-2.0-or-later",
            "type": "project",
            "description": "Libraries for XOOPS 2.5.12",
            "config": {
              "platform": {
                "php": "$PHP_VERSION"
              },
              "allow-plugins": {
                "composer/installers": true
              }
            },
            "require": {
              "php": "^${PHP_VERSION}",
              "xoops/base-requires25": "^1.1.10@beta"
            },
            "require-dev": {
              "phpunit/phpunit": "^9.6 || ^10.5 || ^11.2"
            },
            "minimum-stability": "beta",
            "prefer-stable": true
          }
          EOL

      - name: Install dependencies
        working-directory: htdocs/class/libraries
        run: |
          if [ "${{ matrix.deps }}" = "lowest" ]; then
            composer update --prefer-lowest --prefer-stable --no-interaction --prefer-dist --no-progress
          else
            composer update --prefer-stable --no-interaction --prefer-dist --no-progress
          fi

      - name: Check platform requirements
        working-directory: htdocs/class/libraries
        run: composer check-platform-reqs

      - name: Ensure build directory exists
        run: mkdir -p build/logs

      - name: Create PHPUnit Config
        working-directory: htdocs/class/libraries
        run: |
          cat > phpunit.xml << EOL
          <?xml version="1.0" encoding="UTF-8"?>
          <phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
                   bootstrap="vendor/autoload.php"
                   colors="true"
                   verbose="true"
                   failOnRisky="true"
                   failOnWarning="true"
                   testdox="true">
              <testsuites>
                  <testsuite name="XOOPS Test Suite">
                      <directory>tests</directory>
                  </testsuite>
              </testsuites>
              <coverage>
                  <include>
                      <directory>.</directory>
                  </include>
                  <exclude>
                      <directory>vendor</directory>
                      <directory>tests</directory>
                  </exclude>
              </coverage>
              <php>
                  <ini name="error_reporting" value="-1"/>
                  <ini name="display_errors" value="On"/>
                  <ini name="display_startup_errors" value="On"/>
              </php>
          </phpunit>
          EOL

      - name: Create Test Directory and Sample Test
        working-directory: htdocs/class/libraries
        run: |
          mkdir -p tests
          cat > tests/SampleTest.php << EOL
          <?php
          use PHPUnit\Framework\TestCase;

          class SampleTest extends TestCase
          {
              public function testTrue(): void
              {
                  \$this->assertTrue(true);
              }
          }
          EOL

      - name: Run tests
        if: ${{ !matrix.coverage }}
        working-directory: htdocs/class/libraries
        run: vendor/bin/phpunit --configuration phpunit.xml --stderr

      - name: Run tests with coverage
        if: ${{ matrix.coverage }}
        working-directory: htdocs/class/libraries
        run: vendor/bin/phpunit --configuration phpunit.xml --stderr --coverage-clover ../../../build/logs/clover.xml

      - name: Upload coverage to Codecov
        if: ${{ matrix.coverage }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          files: build/logs/clover.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
